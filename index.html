<!doctype html>
<html>
  <head>
    <title>Facility</title>
    <style>
      body {
        background-color: #111;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        font-family: "Courier New", Courier, monospace; /* Undertale-ish font */
        overflow: hidden;
      }

      #game-container {
        position: relative;
        border: 4px solid white;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
      }

      canvas {
        display: block;
        background-color: #2a2a2a; /* Dark dungeon floor */
        image-rendering: pixelated; /* Keeps pixel art crisp */
      }

      #ui-box {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        height: 100px;
        border: 4px solid white;
        background-color: black;
        padding: 15px;
        box-sizing: border-box;
        display: none; /* Hidden by default */
        font-size: 18px;
        line-height: 1.5;
      }

      #start-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <canvas id="gameCanvas" width="640" height="480"></canvas>

      <div id="ui-box">* <span id="dialogue-text"></span></div>

      <div id="start-screen">
        <h1>DAMIAN RPG</h1>
        <p>WASD to Move | E to Interact</p>
        <p style="color: yellow; margin-top: 20px">[ Click to Start ]</p>
      </div>
    </div>

    <audio id="bgm" loop>
      <source src="music.wav" type="audio/wav" />
    </audio>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const uiBox = document.getElementById("ui-box");
      const dialogueText = document.getElementById("dialogue-text");
      const startScreen = document.getElementById("start-screen");
      const audio = document.getElementById("bgm");

      let gameRunning = false;

      // --- GAME STATE ---
      const player = {
        x: 320,
        y: 240,
        width: 30, // Hitbox width
        height: 50, // Hitbox height
        speed: 4,
        color: "red",
        facing: "down",
        frame: 0,
      };

      const keys = {
        w: false,
        a: false,
        s: false,
        d: false,
        e: false,
      };

      // Objects in the world
      const objects = [
        {
          x: 100,
          y: 100,
          w: 40,
          h: 40,
          color: "#888",
          type: "rock",
          text: "It's a rock. It looks heavy.",
        },
        {
          x: 500,
          y: 300,
          w: 40,
          h: 60,
          color: "#gold",
          type: "save",
          text: "The sight of the hammer fills you with DETERMINATION. (Game Saved)",
        },
      ];

      // --- INPUT HANDLING ---
      window.addEventListener("keydown", (e) => {
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k)) keys[k] = true;
      });

      window.addEventListener("keyup", (e) => {
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k)) keys[k] = false;

        // Interaction logic on key release
        if (k === "e" && gameRunning) interact();
      });

      startScreen.addEventListener("click", () => {
        startScreen.style.display = "none";
        gameRunning = true;
        uiBox.style.display = "block";
        showDialogue("Damian enters the dark room...");

        // Try to play audio (will fail if file missing, which is fine)
        audio.volume = 0.5;
        audio
          .play()
          .catch((e) => console.log("Audio not found or blocked: " + e));

        gameLoop();
      });

      // --- GAME LOGIC ---
      function interact() {
        // Simple proximity check
        let msg = "Nothing here.";

        objects.forEach((obj) => {
          const dist = Math.hypot(player.x - obj.x, player.y - obj.y);
          if (dist < 60) {
            msg = obj.text;
          }
        });

        showDialogue(msg);
      }

      let typeWriterTimer;
      function showDialogue(text) {
        dialogueText.innerHTML = "";
        let i = 0;
        clearInterval(typeWriterTimer);
        typeWriterTimer = setInterval(() => {
          dialogueText.innerHTML += text.charAt(i);
          i++;
          if (i > text.length) clearInterval(typeWriterTimer);
        }, 30); // Typing speed
      }

      function update() {
        if (!gameRunning) return;

        let dx = 0;
        let dy = 0;

        if (keys.w) dy -= player.speed;
        if (keys.s) dy += player.speed;
        if (keys.a) dx -= player.speed;
        if (keys.d) dx += player.speed;

        // Simple animation frame counter
        if (dx !== 0 || dy !== 0) player.frame++;

        player.x += dx;
        player.y += dy;

        // Boundries
        if (player.x < 0) player.x = 0;
        if (player.y < 0) player.y = 0;
        if (player.x > canvas.width - player.width)
          player.x = canvas.width - player.width;
        if (player.y > canvas.height - player.height)
          player.y = canvas.height - player.height;
      }

      // --- RENDERING (PIXEL ART) ---
      function drawPixelRect(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
      }

      function drawDamian(x, y) {
        // This function draws Damian using code primitives based on your image

        const bounce = Math.sin(player.frame / 5) * 2; // Walking bounce

        // 1. Hammer (held in hand)
        drawPixelRect(x - 10, y + 25 + bounce, 8, 20, "#333"); // Handle
        drawPixelRect(x - 14, y + 40 + bounce, 16, 8, "#555"); // Head

        // 2. Body (Red Hoodie)
        drawPixelRect(x, y + 15, 30, 35, "#cc0000");

        // 3. Head (Skin)
        drawPixelRect(x + 2, y, 26, 20, "#ffccaa");

        // 4. Hair (Brown/Orangeish)
        drawPixelRect(x, y - 5, 30, 10, "#cc5500"); // Top hair
        drawPixelRect(x - 2, y, 6, 20, "#cc5500"); // Side hair

        // 5. Headphones (Black)
        drawPixelRect(x - 2, y + 2, 6, 12, "#111"); // Left cup
        drawPixelRect(x + 26, y + 2, 6, 12, "#111"); // Right cup
        drawPixelRect(x, y - 6, 30, 4, "#111"); // Band

        // 6. Glasses (Orange/Gold)
        drawPixelRect(x + 6, y + 6, 20, 6, "#ffaa00");

        // 7. Legs
        drawPixelRect(x + 5, y + 50, 8, 10, "#222"); // Left leg
        drawPixelRect(x + 18, y + 50, 8, 10, "#222"); // Right leg
      }

      function draw() {
        // Clear screen
        ctx.fillStyle = "#2a2a2a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw Grid (Tile effect)
        ctx.strokeStyle = "#222";
        ctx.lineWidth = 2;
        for (let i = 0; i < canvas.width; i += 40) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.stroke();
        }
        for (let i = 0; i < canvas.height; i += 40) {
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(canvas.width, i);
          ctx.stroke();
        }

        // Draw Objects
        objects.forEach((obj) => {
          drawPixelRect(obj.x, obj.y, obj.w, obj.h, obj.color);
          // Save point star
          if (obj.type === "save") {
            ctx.fillStyle = "yellow";
            ctx.font = "20px Arial";
            ctx.fillText("â˜…", obj.x + 10, obj.y + 35);
          }
        });

        // Draw Damian
        drawDamian(player.x, player.y);
      }

      function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }
    </script>
  </body>
</html>
